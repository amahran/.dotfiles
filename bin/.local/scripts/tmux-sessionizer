#!/usr/bin/env bash

# Pick directory (or accept as arg)
if [[ $# -eq 1 ]]; then
  selected=$1
else
  selected=$({
      fd . ~/ ~/personal --min-depth=1 --max-depth=1 --type d -H -a -E .git -E build 
      fd . ~/work --min-depth=1 --max-depth=3 --type d -H -a -E .git -E build 
  } | fzf)
fi

# Normalize & validate
selected="${selected%/}"                # drop trailing /
[[ -z "${selected:-}" ]] && exit 0

# Derive a safe tmux session name
selected_name=$(basename "$selected")
selected_name=${selected_name//./}      # remove dots
selected_name=${selected_name//:/-}     # replace colons (tmux delimiter)

# Ensure session exists (create detached if missing, starting in the target dir)
if ! tmux has-session -t="$selected_name" 2>/dev/null; then
  tmux new-session -ds "$selected_name" -c "$selected"
fi

# Inside tmux: switch client. Outside tmux: attach to session.
if [[ -n "${TMUX:-}" ]]; then
  tmux switch-client -t "$selected_name"
else
  # -A will attach if it exists, or create if it was deleted in the tiny race window.
  tmux new-session -A -s "$selected_name" -c "$selected"
fi

